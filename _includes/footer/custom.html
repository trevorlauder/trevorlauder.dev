<style>
  .consent-banner{position:fixed;left:1rem;right:1rem;bottom:1rem;z-index:9999;max-width:46rem;margin:0 auto;padding:.85rem 1rem;background:#111;border:1px solid #333;border-radius:.5rem;box-shadow:0 6px 24px rgba(0,0,0,.35);color:#eee;font-size:.95rem;line-height:1.35}
  .consent-banner a{color:#9ecbff;text-decoration:underline}
  .consent-actions{display:flex;gap:.5rem;margin-top:.65rem;flex-wrap:wrap}
  .consent-btn{cursor:pointer;padding:.5rem .8rem;border-radius:.35rem;border:1px solid #444;background:#222;color:#eee}
  .consent-btn.primary{background:#2b6cb0;border-color:#2b6cb0}
  .consent-btn:hover{filter:brightness(1.1)}
  .consent-hidden{display:none!important}
</style>
<div id="consent-banner" class="consent-banner consent-hidden" role="dialog" aria-live="polite" aria-label="Privacy options">
  <div>
    I use Google Analytics (GA4) and Cloudflare Web Analytics to measure site usage. You can accept or reject GA4 analytics at any time. See my <a href="/privacy/">Privacy</a> page for more details.
  </div>
  <div class="consent-actions">
    <button id="consent-accept" class="consent-btn primary" type="button">Accept analytics</button>
    <button id="consent-reject" class="consent-btn" type="button">Reject</button>
  </div>
  <span class="sr-only" aria-hidden="true"></span>
  <script>
    (function(){
  var MID = "G-1F9WKFBP24";
      var dnt = (navigator.doNotTrack === '1' || window.doNotTrack === '1' || navigator.msDoNotTrack === '1');
      var $banner = document.getElementById('consent-banner');
      var $accept = document.getElementById('consent-accept');
      var $reject = document.getElementById('consent-reject');

      window.privacyConsent = window.privacyConsent || {};
      function setPref(v){ try{ localStorage.setItem('consent.analytics', v); }catch(e){} }
      function getPref(){ try{ return localStorage.getItem('consent.analytics'); }catch(e){ return null; } }
      function hide(){ if($banner) $banner.classList.add('consent-hidden'); }
      function show(){ if($banner) $banner.classList.remove('consent-hidden'); }
      function hasGtag(){ return typeof window.gtag === 'function'; }
      function updateConsent(val){ if(!hasGtag()) return; window.gtag('consent','update',{ analytics_storage: val }); }

      // Public API to reset preference (used on Privacy page)
      window.privacyConsent.reset = function(){ setPref(''); show(); if(hasGtag()) updateConsent('denied'); };

      // Respect Do Not Track: hide banner and deny analytics
      if(dnt){ hide(); if(MID){ window['ga-disable-' + MID] = true; } if(hasGtag()) updateConsent('denied'); return; }

      // Apply stored preference if present
      var pref = getPref();
      if(pref === 'granted'){ if(hasGtag()) updateConsent('granted'); hide(); }
      else if(pref === 'denied'){ if(hasGtag()) updateConsent('denied'); hide(); }
      else { show(); }

      // Wire buttons
      if($accept) $accept.addEventListener('click', function(){ setPref('granted'); if(hasGtag()) updateConsent('granted'); hide(); });
      if($reject) $reject.addEventListener('click', function(){ setPref('denied'); if(hasGtag()) updateConsent('denied'); hide(); });
    })();
  </script>
</div>

<script>
  (function(){
    try {
      var imgs = document.querySelectorAll('img:not([loading])');
      imgs.forEach(function(img){
        // Skip icons/logos in the masthead to avoid any chance of FOUC
        if (img.closest && img.closest('.masthead')) return;
        img.setAttribute('loading','lazy');
        if(!img.hasAttribute('decoding')) img.setAttribute('decoding','async');
      });
    } catch(e) { /* no-op */ }
  })();
</script>
<div style="text-align:center; margin-top:1rem; font-size:.9rem">
  <a href="/privacy/">Privacy</a>
</div>

<!-- Custom lightweight lightbox (no external library) -->
<style>
/* Basic lightbox overlay */
#lb-overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.85);z-index:9999;color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;padding:1.25rem}
#lb-overlay[aria-hidden="false"]{display:flex}
#lb-overlay figure{margin:0;max-width:min(96vw,1600px);max-height:90vh;display:flex;flex-direction:column;gap:.65rem}
#lb-overlay img{max-width:100%;max-height:70vh;width:auto;height:auto;object-fit:contain;border-radius:4px;box-shadow:0 4px 24px rgba(0,0,0,.55)}
#lb-overlay figcaption{font-size:.8rem;line-height:1.3;color:#ddd;text-align:left}
#lb-overlay button.lb-close{position:absolute;top:.75rem;right:.75rem;background:rgba(0,0,0,.55);border:1px solid rgba(255,255,255,.25);color:#fff;padding:.4rem .65rem;border-radius:.4rem;font-size:.85rem;cursor:pointer}
#lb-overlay button.lb-close:hover{background:rgba(0,0,0,.75)}
#lb-overlay .lb-counter{position:absolute;top:.85rem;left:.95rem;font-size:.7rem;letter-spacing:.5px;text-transform:uppercase;opacity:.75}
#lb-overlay .lb-nav{position:absolute;inset:0;display:flex;align-items:center;justify-content:space-between;pointer-events:none}
#lb-overlay .lb-nav button{pointer-events:auto;background:none;border:none;color:#fff;font-size:2.2rem;line-height:1;cursor:pointer;padding:.75rem .9rem;opacity:.65;transition:opacity .2s}
#lb-overlay .lb-nav button:hover{opacity:1}
#lb-overlay .lb-nav button:focus-visible{outline:2px solid #5ca9ff;outline-offset:2px}
@media (max-width:600px){#lb-overlay .lb-nav button{font-size:1.65rem;padding:.5rem .6rem}}
@media (prefers-reduced-motion:reduce){#lb-overlay *{transition:none!important}}
</style>
<div id="lb-overlay" aria-hidden="true" role="dialog" aria-modal="true" aria-label="Image viewer">
  <div class="lb-counter" aria-live="polite"></div>
  <button class="lb-close" type="button" aria-label="Close (Esc)">Close</button>
  <div class="lb-nav" aria-hidden="true">
    <button type="button" class="lb-prev" aria-label="Previous image">&#10094;</button>
    <button type="button" class="lb-next" aria-label="Next image">&#10095;</button>
  </div>
  <figure>
    <img alt="" />
    <figcaption></figcaption>
  </figure>
</div>
<script>
(function(){
  var overlay = document.getElementById('lb-overlay');
  var imgEl = overlay.querySelector('img');
  var capEl = overlay.querySelector('figcaption');
  var closeBtn = overlay.querySelector('.lb-close');
  var prevBtn = overlay.querySelector('.lb-prev');
  var nextBtn = overlay.querySelector('.lb-next');
  var counterEl = overlay.querySelector('.lb-counter');
  var triggers = [];
  var index = -1;
  var lastFocus = null;

  function collect(){
    triggers = Array.prototype.slice.call(document.querySelectorAll('figure.full a'))
      .filter(function(a){ return a.getAttribute('href'); });
  }
  function open(i){
    if(!triggers.length) collect();
    if(i < 0 || i >= triggers.length) return;
    index = i;
    var a = triggers[i];
    lastFocus = document.activeElement;
    var href = a.getAttribute('href');
    var cap = a.getAttribute('title') || (a.querySelector('img') && a.querySelector('img').getAttribute('alt')) || '';
    imgEl.src = href;
    imgEl.alt = cap || '';
    capEl.textContent = cap;
    counterEl.textContent = (i+1) + ' / ' + triggers.length;
    overlay.setAttribute('aria-hidden','false');
    document.documentElement.classList.add('lb-open');
    disableScroll();
    updateNav();
    closeBtn.focus({preventScroll:true});
  }
  function close(){
    overlay.setAttribute('aria-hidden','true');
    document.documentElement.classList.remove('lb-open');
    enableScroll();
    imgEl.removeAttribute('src');
    if(lastFocus && lastFocus.focus) lastFocus.focus();
  }
  function updateNav(){
    if(!triggers.length) return;
    prevBtn.style.visibility = index > 0 ? 'visible':'hidden';
    nextBtn.style.visibility = index < triggers.length-1 ? 'visible':'hidden';
  }
  function step(dir){
    var nx = index + dir;
    if(nx < 0 || nx >= triggers.length) return;
    open(nx);
  }
  function onKey(e){
    if(overlay.getAttribute('aria-hidden') === 'true') return;
    if(e.key === 'Escape'){ close(); }
    else if(e.key === 'ArrowRight'){ step(1); }
    else if(e.key === 'ArrowLeft'){ step(-1); }
    else if(e.key === 'Tab'){ trapFocus(e); }
  }
  function trapFocus(e){
    var focusables = overlay.querySelectorAll('button, [href], img');
    focusables = Array.prototype.filter.call(focusables, function(el){ return el.offsetParent !== null; });
    if(!focusables.length) return;
    var first = focusables[0];
    var last = focusables[focusables.length-1];
    if(e.shiftKey && document.activeElement === first){ e.preventDefault(); last.focus(); }
    else if(!e.shiftKey && document.activeElement === last){ e.preventDefault(); first.focus(); }
  }
  function disableScroll(){ document.body.style.overflow='hidden'; }
  function enableScroll(){ document.body.style.overflow=''; }

  document.addEventListener('click', function(e){
    var a = e.target.closest && e.target.closest('figure.full a');
    if(!a) return;
    if(a.href.match(/\.(jpe?g|png|webp|avif|gif)$/i)){
      e.preventDefault();
      collect();
      var i = triggers.indexOf(a);
      open(i >=0 ? i : 0);
    }
  });
  closeBtn.addEventListener('click', close);
  overlay.addEventListener('click', function(e){ if(e.target === overlay) close(); });
  prevBtn.addEventListener('click', function(){ step(-1); });
  nextBtn.addEventListener('click', function(){ step(1); });
  document.addEventListener('keydown', onKey);
})();
</script>
